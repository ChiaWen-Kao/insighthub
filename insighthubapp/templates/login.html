{% extends "base.html" %}

{% load static %}

{% block content %}
<div class="container-fluid min-vh-100 d-flex flex-column justify-content-center align-items-center">
  <div class="row w-100 p-4">
    <div class="col-sm-12 col-md-6 col-lg-6 d-flex align-items-center justify-content-center">
      <div class="custom-signup-image-container">
        <img class="custom-signup-image"
          src="https://images.unsplash.com/photo-1460925895917-afdab827c52f?q=80&w=1415&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" />
      </div>
    </div>
    <div class="col-sm-12 col-md-6 col-lg-6 p-5 d-flex align-items-center">
      <form class="custom-signup-form-container w-100" id="login-form">
        {% csrf_token %}
        <div class="row">
          <div class="col-sm-12 col-md-8 col-lg-10">
            <h2 class="mb-2">Log In!</h2>
          </div>
          <div class="col-sm-12 col-md-4 col-lg-2">
            <a href="{% url 'index' %}" class="text-reset"><i class="bi bi-arrow-left-short">Return</i></a>
          </div>
        </div>
        <p class="mb-4">Welcome back! Please enter your account details.</p>
        <div class="form-floating mb-3">
          {{ form.username }}
          <label for="floatingUsername">Username</label>
        </div>
        <div class="form-floating mb-3">
          {{ form.password }}
          <label for="floatingPassword">Password</label>
        </div>
        <div id="login-error-message">
        </div>
        <button type="submit" class="btn btn-dark w-100 mt-5">Submit</button>
        <div class="mt-3 d-flex justify-content-center">
          <p class="m-0">Don't have an account? <a href="{% url 'signup' %}" class="text-reset">Sign Up</a></p>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.getElementById("login-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);
    const errorMessageContainer = document.getElementById("login-error-message");

    try {
      const response = await fetch("{% url 'login' %}", {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
        },
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        window.location.href = data.redirect_url;
      } else {
        const errorObj = JSON.parse(data.error); // Convert string to object
        const errorMessage = errorObj["__all__"]?.[0]?.message || "Login failed";
        errorMessageContainer.classList.add("alert", "alert-danger");
        errorMessageContainer.innerText = errorMessage;
      }
    } catch (err) {
      errorMessageContainer.innerText = "Something went wrong. Please try again.";
    }
  });
</script>
{% endblock %}